<Window x:Class="SPS.App.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:controls="clr-namespace:SPS.App.Views.Controls"
        xmlns:panels="clr-namespace:SPS.App.Views.Panels"
        xmlns:converters="clr-namespace:SPS.App.Views.Converters"
        mc:Ignorable="d"
        Title="Stroke Recovery Progress Monitoring"
        Height="900"
        Width="1400"
        Background="#0F141B"
        Foreground="{StaticResource PrimaryTextBrush}"
        WindowStartupLocation="CenterScreen">
    <Window.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="Styles.xaml"/>
            </ResourceDictionary.MergedDictionaries>
            <converters:ColorToBrushConverter x:Key="ColorToBrushConverter" />
            <converters:EnumToBooleanConverter x:Key="EnumToBooleanConverter" />
            <converters:SensorSelectionStateConverter x:Key="SensorSelectionStateConverter" />
        </ResourceDictionary>
    </Window.Resources>

    <Grid Margin="24" Grid.IsSharedSizeScope="True">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="340" />
            <ColumnDefinition Width="*" />
        </Grid.ColumnDefinitions>

        <ScrollViewer Grid.Column="0"
                      VerticalScrollBarVisibility="Auto"
                      HorizontalScrollBarVisibility="Disabled">
            <StackPanel VerticalAlignment="Stretch">
                <Border Background="{StaticResource SurfaceBrush}"
                        Padding="16"
                        CornerRadius="16"
                        MinWidth="340">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                        </Grid.RowDefinitions>

                        <StackPanel Grid.Row="0">
                            <TextBlock Text="Sensor Control"
                                       FontSize="22"
                                       FontWeight="SemiBold"
                                       Foreground="{StaticResource PrimaryTextBrush}"
                                       Margin="0,0,0,12"
                                       TextTrimming="CharacterEllipsis" />
                            <StackPanel Orientation="Horizontal"
                                        Margin="0,0,0,24"
                                        HorizontalAlignment="Left">
                                <Button Content="Start"
                                        Command="{Binding StartCommand}"
                                        Background="#2C8ED6"
                                        Style="{StaticResource ControlButtonStyle}" />
                                <Button Content="Stop"
                                        Command="{Binding StopCommand}"
                                        Background="#D65C5C"
                                        Style="{StaticResource ControlButtonStyle}" />
                                <Button Content="Reset"
                                        Command="{Binding ResetCommand}"
                                        Background="#374055"
                                        Style="{StaticResource ControlButtonStyle}"
                                        Margin="0" />
                            </StackPanel>

                            <TextBlock Text="Preset"
                                       Style="{StaticResource SectionHeaderText}"
                                       Margin="0,0,0,8" />

                            <UniformGrid Columns="3"
                                         HorizontalAlignment="Stretch"
                                         Margin="0,0,0,4">
                                <ToggleButton Content="Baseline Stable"
                                              Style="{StaticResource ModeToggleButtonStyle}"
                                              IsChecked="{Binding SelectedPreset, Mode=TwoWay, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter=BaselineStable}" />
                                <ToggleButton Content="Fast Exercise"
                                              Style="{StaticResource ModeToggleButtonStyle}"
                                              IsChecked="{Binding SelectedPreset, Mode=TwoWay, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter=FastExercise}" />
                                <ToggleButton Content="Drift Bias"
                                              Style="{StaticResource ModeToggleButtonStyle}"
                                              IsChecked="{Binding SelectedPreset, Mode=TwoWay, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter=DriftBias}" />
                            </UniformGrid>

                            <TextBlock Text="{Binding PresetBannerText}"
                                       Style="{StaticResource BodyMutedText}"
                                       TextAlignment="Left"
                                       Margin="0,4,0,0" />

                            <TextBlock Text="Sensor"
                                       Style="{StaticResource SectionHeaderText}"
                                       Margin="0,24,0,8" />

                            <ItemsControl ItemsSource="{Binding Sensors}"
                                          Margin="0,0,0,8">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <UniformGrid Columns="4" />
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <ToggleButton Content="{Binding Title}"
                                                      Style="{StaticResource ModeToggleButtonStyle}"
                                                      Command="{Binding DataContext.SelectSensorCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                      CommandParameter="{Binding}">
                                            <ToggleButton.IsChecked>
                                            <MultiBinding Converter="{StaticResource SensorSelectionStateConverter}">
                                                <Binding Path="DataContext.SelectedSensor"
                                                         RelativeSource="{RelativeSource AncestorType=ItemsControl}"
                                                         Mode="OneWay" />
                                                <Binding Path="."
                                                         Mode="OneWay" />
                                            </MultiBinding>
                                        </ToggleButton.IsChecked>
                                    </ToggleButton>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                            </ItemsControl>

                            <TextBlock Text="Parameters"
                                       Style="{StaticResource SectionHeaderText}"
                                       Margin="0,24,0,8" />
                        </StackPanel>

                        <ScrollViewer Grid.Row="1"
                                      VerticalScrollBarVisibility="Auto"
                                      CanContentScroll="True"
                                      Padding="8"
                                      Margin="0,8,0,0">
                            <StackPanel>
                                <panels:SensorParametersView DataContext="{Binding CurrentParams}"
                                                             Margin="0,8,0,0" />
                                <Border Background="#101521"
                                        CornerRadius="8"
                                        Margin="0,20,0,0"
                                        Padding="12">
                                    <StackPanel>
                                        <StackPanel Orientation="Horizontal"
                                                    HorizontalAlignment="Stretch"
                                                    VerticalAlignment="Center">
                                            <Border Width="12"
                                                    Height="12"
                                                    CornerRadius="6"
                                                    Background="{Binding BufferStatusBrush}"
                                                    Margin="0,0,8,0" />
                                            <TextBlock Text="{Binding BufferStatus}"
                                                       Foreground="{StaticResource SecondaryTextBrush}"
                                                       Margin="0,0,16,0"
                                                       TextTrimming="CharacterEllipsis" />
                                            <TextBlock Text="FPS"
                                                       Foreground="{StaticResource SecondaryTextBrush}" />
                                            <TextBlock Text="{Binding FramesPerSecond, StringFormat=F1}"
                                                       Margin="8,0,0,0"
                                                       Foreground="{StaticResource PrimaryTextBrush}" />
                                            <TextBlock Text="Buffer"
                                                       Margin="32,0,0,0"
                                                       Foreground="{StaticResource SecondaryTextBrush}" />
                                            <TextBlock Text="{Binding BufferPercent, StringFormat={}{0:F1}%}"
                                                       Margin="8,0,0,0"
                                                       Foreground="{StaticResource PrimaryTextBrush}" />
                                        </StackPanel>
                                        <StackPanel Orientation="Horizontal"
                                                    Margin="0,8,0,0">
                                            <TextBlock Text="Sample Rate"
                                                       Foreground="{StaticResource SecondaryTextBrush}" />
                                            <TextBlock Text="{Binding SampleRate, StringFormat={}{0:F0} Hz}"
                                                       Margin="12,0,0,0"
                                                       Foreground="{StaticResource PrimaryTextBrush}"
                                                       FontWeight="SemiBold" />
                                        </StackPanel>
                                        <TextBlock Text="{Binding StatusMessage}"
                                                   Foreground="#F7A55A"
                                                   Margin="0,8,0,0"
                                                   TextTrimming="CharacterEllipsis" />
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </ScrollViewer>
                    </Grid>
                </Border>

                                <Border Background="{StaticResource CardBrush}" Padding="16" CornerRadius="12" Margin="0,16,0,0">
                    <StackPanel>
                        <TextBlock Text="Combined (normalized unity weights)" FontSize="16" FontWeight="SemiBold" />
                        <TextBlock Text="{Binding CombinedFormulaText}"
                                   Margin="0,6,0,0"
                                   Style="{StaticResource ParameterHintStyle}" />
                        <TextBlock Text="All sensors contribute equally; this card only reports stability and response deltas."
                                   Margin="0,6,0,0"
                                   TextWrapping="Wrap"
                                   Foreground="{StaticResource SecondaryTextBrush}" />
                        <TextBlock Text="{Binding CombinedStatus}"
                                   Margin="0,8,0,0">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Foreground" Value="{StaticResource SecondaryTextBrush}" />
                                    <Setter Property="Visibility" Value="Visible" />
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding CombinedStatus}" Value="">
                                            <Setter Property="Visibility" Value="Collapsed" />
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding CombinedStatus}" Value="{x:Null}">
                                            <Setter Property="Visibility" Value="Collapsed" />
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding IsCombinedStable}" Value="False">
                                            <Setter Property="Foreground" Value="#FF5C6B" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                    </StackPanel>
                </Border>

                <TextBlock Text="Abdurrauf Almutawakkil&#x0a;2042241115"
                           Margin="0,16,0,0"
                           HorizontalAlignment="Center"
                           TextAlignment="Center"
                           Opacity="0.6"
                           Style="{StaticResource BodyMutedText}" />
            </StackPanel>
        </ScrollViewer>

        <Grid Grid.Column="1" Margin="24,0,0,0">
            <Grid.RowDefinitions>
                <RowDefinition Height="*" />
                <RowDefinition Height="*" />
                <RowDefinition Height="*" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <UniformGrid Grid.Row="0" Grid.ColumnSpan="3" Columns="3">
                <Border Background="{StaticResource SurfaceBrush}" CornerRadius="12" Margin="8">
                    <Border.DataContext>
                        <Binding Path="CombinedTimePlot" />
                    </Border.DataContext>
                    <Grid>
                        <controls:PlotHost />
                        <Border Background="#66000000"
                                CornerRadius="6"
                                Padding="10,4"
                                HorizontalAlignment="Left"
                                VerticalAlignment="Top"
                                Margin="12">
                            <Border.Style>
                                <Style TargetType="Border">
                                    <Setter Property="Visibility" Value="Visible" />
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding DataContext.ActivePresetLabel, RelativeSource={RelativeSource AncestorType=Window}}" Value="">
                                            <Setter Property="Visibility" Value="Collapsed" />
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding DataContext.ActivePresetLabel, RelativeSource={RelativeSource AncestorType=Window}}" Value="{x:Null}">
                                            <Setter Property="Visibility" Value="Collapsed" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Border.Style>
                            <TextBlock Text="{Binding DataContext.ActivePresetLabel, RelativeSource={RelativeSource AncestorType=Window}}"
                                       FontSize="12"
                                       FontWeight="SemiBold"
                                       Foreground="{StaticResource PrimaryTextBrush}" />
                        </Border>
                    </Grid>
                </Border>
                <Border Background="{StaticResource SurfaceBrush}" CornerRadius="12" Margin="8">
                    <Border.DataContext>
                        <Binding Path="ImuTimePlot" />
                    </Border.DataContext>
                    <controls:PlotHost />
                </Border>
                <Border Background="{StaticResource SurfaceBrush}" CornerRadius="12" Margin="8">
                    <Border.DataContext>
                        <Binding Path="FsrTimePlot" />
                    </Border.DataContext>
                    <controls:PlotHost />
                </Border>
            </UniformGrid>

            <UniformGrid Grid.Row="1" Grid.ColumnSpan="3" Columns="3">
                <Border Background="{StaticResource SurfaceBrush}" CornerRadius="12" Margin="8">
                    <Border.DataContext>
                        <Binding Path="ImuFftPlot" />
                    </Border.DataContext>
                    <controls:PlotHost />
                </Border>
                <Border Background="{StaticResource SurfaceBrush}" CornerRadius="12" Margin="8">
                    <Border.DataContext>
                        <Binding Path="FsrFftPlot" />
                    </Border.DataContext>
                    <controls:PlotHost />
                </Border>
                <Border Background="{StaticResource SurfaceBrush}" CornerRadius="12" Margin="8">
                    <Border.DataContext>
                        <Binding Path="EmgFftPlot" />
                    </Border.DataContext>
                    <controls:PlotHost />
                </Border>
            </UniformGrid>

            <Border Grid.Row="2" Grid.Column="0" Background="{StaticResource SurfaceBrush}" CornerRadius="12" Margin="8">
                <Border.DataContext>
                    <Binding Path="StrainTimePlot" />
                </Border.DataContext>
                <controls:PlotHost />
            </Border>

            <Border Grid.Row="3" Grid.Column="0" Grid.ColumnSpan="2" Background="{StaticResource SurfaceBrush}" CornerRadius="12" Margin="8">
                <Border.DataContext>
                    <Binding Path="BodePlot" />
                </Border.DataContext>
                <controls:PlotHost />
            </Border>

            <Border Grid.Row="3" Grid.Column="2" Background="{StaticResource SurfaceBrush}" CornerRadius="12" Margin="8">
                <Grid>
                    <TabControl Background="{StaticResource SurfaceBrush}"
                                BorderThickness="0"
                                Padding="4">
                        <TabItem Header="Z-domain">
                            <controls:PlotHost DataContext="{Binding PoleZeroPlot}" />
                        </TabItem>
                        <TabItem Header="S-domain">
                            <controls:PlotHost DataContext="{Binding SPlanePlot}" />
                        </TabItem>
                    </TabControl>
                    <TextBlock Text="{Binding DataContext.CombinedStatus, RelativeSource={RelativeSource AncestorType=Window}}"
                               HorizontalAlignment="Center"
                               VerticalAlignment="Top"
                               Margin="0,12,0,0"
                               FontWeight="SemiBold">
                        <TextBlock.Style>
                            <Style TargetType="TextBlock">
                                <Setter Property="Visibility" Value="Collapsed" />
                                <Setter Property="Foreground" Value="#FF5C6B" />
                                <Setter Property="Background" Value="#66000000" />
                                <Setter Property="Padding" Value="12,6" />
                                <Setter Property="TextWrapping" Value="Wrap" />
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding DataContext.IsCombinedStable, RelativeSource={RelativeSource AncestorType=Window}}" Value="False">
                                        <Setter Property="Visibility" Value="Visible" />
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>
                    </TextBlock>
                </Grid>
            </Border>

            <Border Grid.Row="2" Grid.Column="1" Background="{StaticResource SurfaceBrush}" CornerRadius="12" Margin="8">
                <Border.DataContext>
                    <Binding Path="EmgTimePlot" />
                </Border.DataContext>
                <controls:PlotHost />
            </Border>

            <Border Grid.Row="2" Grid.Column="2" Background="{StaticResource SurfaceBrush}" CornerRadius="12" Margin="8">
                <Border.DataContext>
                    <Binding Path="StrainEmgFftPlot" />
                </Border.DataContext>
                <controls:PlotHost />
            </Border>
        </Grid>
    </Grid>
</Window>

















